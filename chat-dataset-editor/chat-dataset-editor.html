<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Dataset Editor</title>
    <!-- Load PapaParse for robust CSV handling -->
    <script src="papaparse.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --success: #16a34a;
            --danger: #dc2626;
            --bg: #f1f5f9;
            --card: #ffffff;
            --text: #0f172a;
            --border: #cbd5e1;
            --readonly-bg: #e2e8f0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 95%; 
            background: var(--card);
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            padding-bottom: 1rem;
        }

        h1 { margin: 0; font-size: 1.5rem; color: var(--primary); }

        /* Sections */
        .section { display: none; flex-direction: column; gap: 1rem; }
        .section.active { display: flex; }

        /* File Upload */
        .upload-box {
            border: 2px dashed var(--border);
            padding: 4rem;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background-color: #f8fafc;
        }
        
        .upload-box:hover, .upload-box.drag-active { 
            border-color: var(--primary); 
            background-color: #eff6ff;
            transform: scale(1.01);
        }

        /* Editor Layout */
        .editor-layout {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            width: 100%;
        }

        .field-group { display: flex; flex-direction: column; gap: 0.5rem; width: 100%; }
        .field-group label { font-weight: 700; font-size: 0.95rem; color: #334155; }
        
        /* Textareas */
        textarea {
            width: 100%;
            min-height: 150px; /* Default height */
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: monospace; 
            font-size: 1rem;
            resize: vertical;
            box-sizing: border-box;
            line-height: 1.5;
            background-color: #fff;
        }

        /* Specific override for Question field height */
        #a-input {
            min-height: 300px;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Read Only ID Input */
        .id-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: monospace;
            font-size: 1rem;
            background-color: var(--readonly-bg);
            color: #64748b;
            cursor: not-allowed;
            box-sizing: border-box;
        }

        /* Top Info Bar in Editor */
        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f1f5f9;
            padding: 10px 15px;
            border-radius: 6px;
        }

        /* Controls */
        .controls {
            display: flex;
            justify-content: flex-end; 
            align-items: center;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
            gap: 1rem;
        }

        .btn-group { display: flex; gap: 1rem; width: 100%; }
        
        button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
        }

        .btn-skip { background-color: #e2e8f0; color: #475569; flex: 1; }
        .btn-skip:hover { background-color: #cbd5e1; }
        
        .btn-save { background-color: var(--success); color: white; flex: 2; }
        .btn-save:hover { opacity: 0.9; }
        
        /* Button Styles */
        .btn-download-early {
            background-color: var(--primary);
            color: white;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
        .btn-download-early:hover { background-color: var(--primary-hover); }

        .btn-download-final { 
            background-color: var(--primary); 
            color: white; 
            width: 100%; 
            padding: 1.5rem; 
            font-size: 1.25rem; 
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            text-align: center;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        .stat-val { font-size: 2rem; font-weight: bold; display: block; margin-bottom: 0.5rem; }
        .stat-label { font-size: 0.85rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; }

    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Chat Dataset Editor</h1>
        <button id="header-dl-btn" class="btn-download-early" style="display:none;" onclick="downloadCSV()">
            â¬‡ Download CSV (<span id="header-kept-count">0</span>)
        </button>
    </header>

    <!-- Upload Screen -->
    <div id="screen-upload" class="section active">
        <!-- Added ID for Drop Zone logic -->
        <div id="drop-zone" class="upload-box" onclick="document.getElementById('fileInput').click()">
            <h3 style="margin-top:0">Upload CSV</h3>
            <p style="color: #64748b;">Click or Drag & Drop file here</p>
            <p style="font-size: 0.8rem; color: #94a3b8;">Must contain "id", "question", and "answer" columns</p>
            <input type="file" id="fileInput" accept=".csv" style="display: none" onchange="handleInputChange(event)">
        </div>
    </div>

    <!-- Editor Screen -->
    <div id="screen-editor" class="section">
        
        <div class="editor-header">
            <div>
                <strong>Progress: </strong> <span id="current-count">0</span> / <span id="total-count">0</span>
            </div>
            <div>
                <strong>Kept: </strong> <span id="kept-count" style="color: var(--success); font-weight: bold;">0</span>
            </div>
        </div>

        <div class="editor-layout">
            <!-- ID Field -->
            <div class="field-group">
                <label for="id-display">ID (Read Only)</label>
                <input type="text" id="id-display" class="id-input" readonly>
            </div>

            <!-- Question Field -->
            <div class="field-group">
                <label for="q-input">Question</label>
                <textarea id="q-input" placeholder="Question text..."></textarea>
            </div>

            <!-- Answer Field -->
            <div class="field-group">
                <label for="a-input">Answer</label>
                <textarea id="a-input" placeholder="Answer text..."></textarea>
            </div>
        </div>

        <div class="controls">
            <div class="btn-group">
                <button class="btn-skip" onclick="skipPair()">Discard & Next</button>
                <button class="btn-save" onclick="savePair()">Save & Next</button>
            </div>
        </div>
    </div>

    <!-- Finished Screen -->
    <div id="screen-finish" class="section">
        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-val" id="stat-total">0</span>
                <span class="stat-label">Total Processed</span>
            </div>
            <div class="stat-card">
                <span class="stat-val" id="stat-kept" style="color: var(--success)">0</span>
                <span class="stat-label">Kept</span>
            </div>
            <div class="stat-card">
                <span class="stat-val" id="stat-discarded" style="color: var(--danger)">0</span>
                <span class="stat-label">Discarded</span>
            </div>
        </div>
        
        <h2>Review Complete!</h2>
        <p>You have reached the end of the file.</p>
        <button class="btn-download-final" onclick="downloadCSV()">Download Final CSV</button>
        <button class="btn-skip" style="margin-top: 10px; width: 100%; padding: 1rem;" onclick="location.reload()">Start Over</button>
    </div>
</div>

<script>
    // State
    let rawData = [];
    let curatedData = [];
    let currentIndex = 0;

    // DOM Elements
    const screens = {
        upload: document.getElementById('screen-upload'),
        editor: document.getElementById('screen-editor'),
        finish: document.getElementById('screen-finish')
    };

    const inputs = {
        id: document.getElementById('id-display'),
        q: document.getElementById('q-input'),
        a: document.getElementById('a-input')
    };

    const displays = {
        current: document.getElementById('current-count'),
        total: document.getElementById('total-count'),
        kept: document.getElementById('kept-count'),
        headerKept: document.getElementById('header-kept-count'),
        headerBtn: document.getElementById('header-dl-btn'),
        statTotal: document.getElementById('stat-total'),
        statKept: document.getElementById('stat-kept'),
        statDiscarded: document.getElementById('stat-discarded')
    };

    // --- Drag and Drop Logic ---
    const dropZone = document.getElementById('drop-zone');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
    });

    function highlight(e) {
        dropZone.classList.add('drag-active');
    }

    function unhighlight(e) {
        dropZone.classList.remove('drag-active');
    }

    dropZone.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
    }
    
    // --- File Handling ---

    function handleInputChange(event) {
        handleFiles(event.target.files);
    }

    function handleFiles(files) {
        const file = files[0];
        if (!file) return;
        
        // Simple check to ensure it looks like a CSV
        if(file.type && file.type !== "text/csv" && !file.name.endsWith('.csv')) {
            alert("Please upload a .csv file");
            return;
        }

        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                if (results.data && results.data.length > 0) {
                    const headers = results.meta.fields.map(h => h.toLowerCase());
                    const hasQ = headers.includes('question');
                    const hasA = headers.includes('answer');
                    
                    if (!hasQ || !hasA) {
                        alert('Error: CSV must contain columns named "question" and "answer".');
                        return;
                    }
                    
                    rawData = results.data;
                    startReview();
                } else {
                    alert('File appears to be empty or invalid.');
                }
            },
            error: function(err) {
                alert('Error parsing CSV: ' + err.message);
            }
        });
    }

    // --- App Logic ---

    function startReview() {
        currentIndex = 0;
        curatedData = [];
        showScreen('editor');
        displays.headerBtn.style.display = 'block'; 
        updateStats();
        loadPair();
    }

    function loadPair() {
        if (currentIndex >= rawData.length) {
            finishReview();
            return;
        }

        const item = rawData[currentIndex];
        const keys = Object.keys(item);
        const qKey = keys.find(k => k.toLowerCase() === 'question');
        const aKey = keys.find(k => k.toLowerCase() === 'answer');
        const idKey = keys.find(k => k.toLowerCase() === 'id');

        inputs.id.value = idKey ? item[idKey] : 'N/A';
        inputs.q.value = item[qKey] || '';
        inputs.a.value = item[aKey] || '';

        inputs.q.focus();
        updateStats();
    }

    function savePair() {
        const id = inputs.id.value;
        const q = inputs.q.value.trim();
        const a = inputs.a.value.trim();

        if (!q || !a) {
            if(!confirm("One of the fields is empty. Keep anyway?")) return;
        }

        curatedData.push({
            id: id,
            question: q,
            answer: a
        });

        next();
    }

    function skipPair() {
        next();
    }

    function next() {
        currentIndex++;
        loadPair();
    }

    function finishReview() {
        showScreen('finish');
        displays.headerBtn.style.display = 'none'; 
        displays.statTotal.textContent = rawData.length;
        displays.statKept.textContent = curatedData.length;
        displays.statDiscarded.textContent = rawData.length - curatedData.length;
    }

    function downloadCSV() {
        if (curatedData.length === 0) {
            alert("No data has been kept yet!");
            return;
        }
        
        const csv = Papa.unparse(curatedData);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", `curated_data_${curatedData.length}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function showScreen(screenName) {
        Object.values(screens).forEach(el => el.classList.remove('active'));
        screens[screenName].classList.add('active');
    }

    function updateStats() {
        displays.current.textContent = currentIndex + 1;
        displays.total.textContent = rawData.length;
        displays.kept.textContent = curatedData.length;
        displays.headerKept.textContent = curatedData.length;
    }

    document.addEventListener('keydown', (e) => {
        if (!screens.editor.classList.contains('active')) return;
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            savePair();
        }
    });

</script>

</body>
</html>